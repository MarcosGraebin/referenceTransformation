#include "SingleLib.h"

// Lookup table to avoid the use of math.h, that has a float input in the specific fixed-point format
const uint16_t cos_16[2880] = {32768,32767,32767,32767,32767,32767,32767,32767,32767,32767,32767,32767,32767,32767,32767,32766,32766,32766,32766,32766,32766,
32765,32765,32765,32765,32764,32764,32764,32764,32763,32763,32763,32763,32762,32762,32762,32761,32761,32760,32760,32760,
32759,32759,32758,32758,32758,32757,32757,32756,32756,32755,32755,32754,32754,32753,32753,32752,32752,32751,32751,32750,
32749,32749,32748,32748,32747,32746,32746,32745,32744,32744,32743,32742,32742,32741,32740,32739,32739,32738,32737,32736,
32736,32735,32734,32733,32732,32731,32731,32730,32729,32728,32727,32726,32725,32724,32724,32723,32722,32721,32720,32719,
32718,32717,32716,32715,32714,32713,32712,32711,32710,32709,32707,32706,32705,32704,32703,32702,32701,32700,32699,32697,
32696,32695,32694,32693,32691,32690,32689,32688,32686,32685,32684,32683,32681,32680,32679,32677,32676,32675,32673,32672,
32671,32669,32668,32666,32665,32664,32662,32661,32659,32658,32656,32655,32653,32652,32650,32649,32647,32646,32644,32643,
32641,32640,32638,32636,32635,32633,32632,32630,32628,32627,32625,32623,32622,32620,32618,32617,32615,32613,32611,32610,
32608,32606,32604,32603,32601,32599,32597,32595,32594,32592,32590,32588,32586,32584,32582,32580,32579,32577,32575,32573,
32571,32569,32567,32565,32563,32561,32559,32557,32555,32553,32551,32549,32547,32545,32542,32540,32538,32536,32534,32532,
32530,32528,32525,32523,32521,32519,32517,32514,32512,32510,32508,32506,32503,32501,32499,32496,32494,32492,32489,32487,
32485,32482,32480,32478,32475,32473,32471,32468,32466,32463,32461,32458,32456,32454,32451,32449,32446,32444,32441,32439,
32436,32434,32431,32428,32426,32423,32421,32418,32415,32413,32410,32408,32405,32402,32400,32397,32394,32392,32389,32386,
32383,32381,32378,32375,32372,32370,32367,32364,32361,32358,32356,32353,32350,32347,32344,32341,32339,32336,32333,32330,
32327,32324,32321,32318,32315,32312,32309,32306,32303,32300,32297,32294,32291,32288,32285,32282,32279,32276,32273,32270,
32267,32263,32260,32257,32254,32251,32248,32245,32241,32238,32235,32232,32229,32225,32222,32219,32216,32212,32209,32206,
32202,32199,32196,32192,32189,32186,32182,32179,32176,32172,32169,32165,32162,32159,32155,32152,32148,32145,32141,32138,
32134,32131,32127,32124,32120,32117,32113,32110,32106,32103,32099,32095,32092,32088,32084,32081,32077,32074,32070,32066,
32063,32059,32055,32051,32048,32044,32040,32037,32033,32029,32025,32021,32018,32014,32010,32006,32002,31998,31995,31991,
31987,31983,31979,31975,31971,31967,31963,31960,31956,31952,31948,31944,31940,31936,31932,31928,31924,31920,31916,31912,
31907,31903,31899,31895,31891,31887,31883,31879,31875,31870,31866,31862,31858,31854,31850,31845,31841,31837,31833,31828,
31824,31820,31816,31811,31807,31803,31798,31794,31790,31785,31781,31777,31772,31768,31764,31759,31755,31750,31746,31742,
31737,31733,31728,31724,31719,31715,31710,31706,31701,31697,31692,31688,31683,31679,31674,31669,31665,31660,31656,31651,
31646,31642,31637,31632,31628,31623,31618,31614,31609,31604,31600,31595,31590,31585,31581,31576,31571,31566,31561,31557,
31552,31547,31542,31537,31532,31528,31523,31518,31513,31508,31503,31498,31493,31488,31483,31478,31473,31468,31463,31458,
31453,31448,31443,31438,31433,31428,31423,31418,31413,31408,31403,31398,31393,31387,31382,31377,31372,31367,31362,31357,
31351,31346,31341,31336,31330,31325,31320,31315,31309,31304,31299,31294,31288,31283,31278,31272,31267,31262,31256,31251,
31246,31240,31235,31229,31224,31218,31213,31208,31202,31197,31191,31186,31180,31175,31169,31164,31158,31153,31147,31142,
31136,31130,31125,31119,31114,31108,31102,31097,31091,31085,31080,31074,31068,31063,31057,31051,31046,31040,31034,31029,
31023,31017,31011,31005,31000,30994,30988,30982,30976,30971,30965,30959,30953,30947,30941,30935,30930,30924,30918,30912,
30906,30900,30894,30888,30882,30876,30870,30864,30858,30852,30846,30840,30834,30828,30822,30816,30810,30804,30797,30791,
30785,30779,30773,30767,30761,30755,30748,30742,30736,30730,30724,30717,30711,30705,30699,30692,30686,30680,30674,30667,
30661,30655,30648,30642,30636,30629,30623,30617,30610,30604,30597,30591,30585,30578,30572,30565,30559,30552,30546,30540,
30533,30527,30520,30514,30507,30501,30494,30487,30481,30474,30468,30461,30455,30448,30441,30435,30428,30421,30415,30408,
30402,30395,30388,30381,30375,30368,30361,30355,30348,30341,30334,30328,30321,30314,30307,30300,30294,30287,30280,30273,
30266,30259,30253,30246,30239,30232,30225,30218,30211,30204,30197,30190,30184,30177,30170,30163,30156,30149,30142,30135,
30128,30121,30114,30106,30099,30092,30085,30078,30071,30064,30057,30050,30043,30035,30028,30021,30014,30007,30000,29992,
29985,29978,29971,29964,29956,29949,29942,29935,29927,29920,29913,29905,29898,29891,29883,29876,29869,29861,29854,29847,
29839,29832,29825,29817,29810,29802,29795,29787,29780,29772,29765,29758,29750,29743,29735,29728,29720,29712,29705,29697,
29690,29682,29675,29667,29660,29652,29644,29637,29629,29621,29614,29606,29598,29591,29583,29575,29568,29560,29552,29545,
29537,29529,29521,29514,29506,29498,29490,29482,29475,29467,29459,29451,29443,29435,29428,29420,29412,29404,29396,29388,
29380,29372,29364,29357,29349,29341,29333,29325,29317,29309,29301,29293,29285,29277,29269,29261,29253,29245,29236,29228,
29220,29212,29204,29196,29188,29180,29172,29163,29155,29147,29139,29131,29123,29114,29106,29098,29090,29082,29073,29065,
29057,29049,29040,29032,29024,29015,29007,28999,28990,28982,28974,28965,28957,28949,28940,28932,28924,28915,28907,28898,
28890,28881,28873,28865,28856,28848,28839,28831,28822,28814,28805,28797,28788,28780,28771,28762,28754,28745,28737,28728,
28719,28711,28702,28694,28685,28676,28668,28659,28650,28642,28633,28624,28616,28607,28598,28589,28581,28572,28563,28554,
28546,28537,28528,28519,28511,28502,28493,28484,28475,28466,28458,28449,28440,28431,28422,28413,28404,28395,28386,28377,
28368,28360,28351,28342,28333,28324,28315,28306,28297,28288,28279,28270,28261,28251,28242,28233,28224,28215,28206,28197,
28188,28179,28170,28161,28151,28142,28133,28124,28115,28106,28096,28087,28078,28069,28060,28050,28041,28032,28023,28013,
28004,27995,27985,27976,27967,27957,27948,27939,27929,27920,27911,27901,27892,27883,27873,27864,27854,27845,27836,27826,
27817,27807,27798,27788,27779,27769,27760,27750,27741,27731,27722,27712,27703,27693,27684,27674,27665,27655,27645,27636,
27626,27617,27607,27597,27588,27578,27568,27559,27549,27539,27530,27520,27510,27501,27491,27481,27471,27462,27452,27442,
27432,27423,27413,27403,27393,27383,27373,27364,27354,27344,27334,27324,27314,27305,27295,27285,27275,27265,27255,27245,
27235,27225,27215,27205,27195,27185,27175,27165,27155,27145,27135,27125,27115,27105,27095,27085,27075,27065,27055,27045,
27035,27025,27015,27004,26994,26984,26974,26964,26954,26944,26933,26923,26913,26903,26893,26882,26872,26862,26852,26841,
26831,26821,26811,26800,26790,26780,26770,26759,26749,26739,26728,26718,26708,26697,26687,26676,26666,26656,26645,26635,
26624,26614,26604,26593,26583,26572,26562,26551,26541,26530,26520,26509,26499,26488,26478,26467,26457,26446,26436,26425,
26415,26404,26393,26383,26372,26362,26351,26340,26330,26319,26308,26298,26287,26276,26266,26255,26244,26234,26223,26212,
26201,26191,26180,26169,26158,26148,26137,26126,26115,26105,26094,26083,26072,26061,26050,26040,26029,26018,26007,25996,
25985,25974,25963,25953,25942,25931,25920,25909,25898,25887,25876,25865,25854,25843,25832,25821,25810,25799,25788,25777,
25766,25755,25744,25733,25722,25711,25700,25688,25677,25666,25655,25644,25633,25622,25611,25599,25588,25577,25566,25555,
25544,25532,25521,25510,25499,25487,25476,25465,25454,25443,25431,25420,25409,25397,25386,25375,25363,25352,25341,25330,
25318,25307,25295,25284,25273,25261,25250,25239,25227,25216,25204,25193,25181,25170,25159,25147,25136,25124,25113,25101,
25090,25078,25067,25055,25044,25032,25021,25009,24998,24986,24974,24963,24951,24940,24928,24916,24905,24893,24882,24870,
24858,24847,24835,24823,24812,24800,24788,24777,24765,24753,24742,24730,24718,24706,24695,24683,24671,24659,24648,24636,
24624,24612,24600,24589,24577,24565,24553,24541,24529,24518,24506,24494,24482,24470,24458,24446,24434,24422,24411,24399,
24387,24375,24363,24351,24339,24327,24315,24303,24291,24279,24267,24255,24243,24231,24219,24207,24195,24183,24171,24159,
24147,24134,24122,24110,24098,24086,24074,24062,24050,24038,24025,24013,24001,23989,23977,23964,23952,23940,23928,23916,
23903,23891,23879,23867,23855,23842,23830,23818,23805,23793,23781,23769,23756,23744,23732,23719,23707,23695,23682,23670,
23658,23645,23633,23620,23608,23596,23583,23571,23558,23546,23534,23521,23509,23496,23484,23471,23459,23446,23434,23421,
23409,23396,23384,23371,23359,23346,23334,23321,23309,23296,23283,23271,23258,23246,23233,23220,23208,23195,23183,23170,
23157,23145,23132,23119,23107,23094,23081,23069,23056,23043,23031,23018,23005,22992,22980,22967,22954,22941,22929,22916,
22903,22890,22877,22865,22852,22839,22826,22813,22801,22788,22775,22762,22749,22736,22723,22711,22698,22685,22672,22659,
22646,22633,22620,22607,22594,22581,22568,22556,22543,22530,22517,22504,22491,22478,22465,22452,22439,22426,22412,22399,
22386,22373,22360,22347,22334,22321,22308,22295,22282,22269,22256,22242,22229,22216,22203,22190,22177,22164,22150,22137,
22124,22111,22098,22084,22071,22058,22045,22032,22018,22005,21992,21979,21965,21952,21939,21926,21912,21899,21886,21872,
21859,21846,21832,21819,21806,21792,21779,21766,21752,21739,21726,21712,21699,21685,21672,21659,21645,21632,21618,21605,
21592,21578,21565,21551,21538,21524,21511,21497,21484,21470,21457,21443,21430,21416,21403,21389,21376,21362,21348,21335,
21321,21308,21294,21281,21267,21253,21240,21226,21213,21199,21185,21172,21158,21144,21131,21117,21103,21090,21076,21062,
21049,21035,21021,21008,20994,20980,20966,20953,20939,20925,20911,20898,20884,20870,20856,20843,20829,20815,20801,20787,
20773,20760,20746,20732,20718,20704,20690,20677,20663,20649,20635,20621,20607,20593,20579,20565,20552,20538,20524,20510,
20496,20482,20468,20454,20440,20426,20412,20398,20384,20370,20356,20342,20328,20314,20300,20286,20272,20258,20244,20230,
20216,20202,20188,20173,20159,20145,20131,20117,20103,20089,20075,20061,20047,20032,20018,20004,19990,19976,19962,19947,
19933,19919,19905,19891,19876,19862,19848,19834,19820,19805,19791,19777,19763,19748,19734,19720,19705,19691,19677,19663,
19648,19634,19620,19605,19591,19577,19562,19548,19534,19519,19505,19491,19476,19462,19448,19433,19419,19404,19390,19376,
19361,19347,19332,19318,19303,19289,19275,19260,19246,19231,19217,19202,19188,19173,19159,19144,19130,19115,19101,19086,
19072,19057,19043,19028,19013,18999,18984,18970,18955,18941,18926,18911,18897,18882,18868,18853,18838,18824,18809,18794,
18780,18765,18751,18736,18721,18707,18692,18677,18662,18648,18633,18618,18604,18589,18574,18559,18545,18530,18515,18501,
18486,18471,18456,18441,18427,18412,18397,18382,18368,18353,18338,18323,18308,18293,18279,18264,18249,18234,18219,18204,
18190,18175,18160,18145,18130,18115,18100,18085,18070,18056,18041,18026,18011,17996,17981,17966,17951,17936,17921,17906,
17891,17876,17861,17846,17831,17816,17801,17786,17771,17756,17741,17726,17711,17696,17681,17666,17651,17636,17621,17606,
17591,17576,17560,17545,17530,17515,17500,17485,17470,17455,17440,17424,17409,17394,17379,17364,17349,17334,17318,17303,
17288,17273,17258,17242,17227,17212,17197,17182,17166,17151,17136,17121,17105,17090,17075,17060,17044,17029,17014,16999,
16983,16968,16953,16938,16922,16907,16892,16876,16861,16846,16830,16815,16800,16784,16769,16754,16738,16723,16707,16692,
16677,16661,16646,16631,16615,16600,16584,16569,16553,16538,16523,16507,16492,16476,16461,16445,16430,16414,16399,16384,
16368,16353,16337,16322,16306,16291,16275,16260,16244,16228,16213,16197,16182,16166,16151,16135,16120,16104,16089,16073,
16057,16042,16026,16011,15995,15979,15964,15948,15933,15917,15901,15886,15870,15854,15839,15823,15808,15792,15776,15761,
15745,15729,15714,15698,15682,15666,15651,15635,15619,15604,15588,15572,15556,15541,15525,15509,15493,15478,15462,15446,
15430,15415,15399,15383,15367,15352,15336,15320,15304,15288,15273,15257,15241,15225,15209,15193,15178,15162,15146,15130,
15114,15098,15082,15067,15051,15035,15019,15003,14987,14971,14955,14940,14924,14908,14892,14876,14860,14844,14828,14812,
14796,14780,14764,14748,14732,14716,14700,14684,14668,14652,14637,14621,14605,14589,14573,14556,14540,14524,14508,14492,
14476,14460,14444,14428,14412,14396,14380,14364,14348,14332,14316,14300,14284,14268,14251,14235,14219,14203,14187,14171,
14155,14139,14123,14106,14090,14074,14058,14042,14026,14010,13993,13977,13961,13945,13929,13913,13896,13880,13864,13848,
13832,13815,13799,13783,13767,13751,13734,13718,13702,13686,13669,13653,13637,13621,13604,13588,13572,13556,13539,13523,
13507,13491,13474,13458,13442,13425,13409,13393,13376,13360,13344,13327,13311,13295,13278,13262,13246,13229,13213,13197,
13180,13164,13148,13131,13115,13098,13082,13066,13049,13033,13017,13000,12984,12967,12951,12934,12918,12902,12885,12869,
12852,12836,12819,12803,12787,12770,12754,12737,12721,12704,12688,12671,12655,12638,12622,12605,12589,12572,12556,12539,
12523,12506,12490,12473,12457,12440,12424,12407,12391,12374,12357,12341,12324,12308,12291,12275,12258,12241,12225,12208,
12192,12175,12159,12142,12125,12109,12092,12075,12059,12042,12026,12009,11992,11976,11959,11942,11926,11909,11893,11876,
11859,11843,11826,11809,11793,11776,11759,11743,11726,11709,11692,11676,11659,11642,11626,11609,11592,11575,11559,11542,
11525,11509,11492,11475,11458,11442,11425,11408,11391,11375,11358,11341,11324,11308,11291,11274,11257,11240,11224,11207,
11190,11173,11156,11140,11123,11106,11089,11072,11056,11039,11022,11005,10988,10971,10955,10938,10921,10904,10887,10870,
10853,10837,10820,10803,10786,10769,10752,10735,10718,10702,10685,10668,10651,10634,10617,10600,10583,10566,10549,10532,
10516,10499,10482,10465,10448,10431,10414,10397,10380,10363,10346,10329,10312,10295,10278,10261,10244,10227,10210,10193,
10176,10159,10142,10125,10108,10091,10074,10057,10040,10023,10006,9989,9972,9955,9938,9921,9904,9887,9870,9853,
9836,9819,9802,9785,9768,9751,9734,9717,9700,9682,9665,9648,9631,9614,9597,9580,9563,9546,9529,9512,
9494,9477,9460,9443,9426,9409,9392,9375,9358,9340,9323,9306,9289,9272,9255,9238,9220,9203,9186,9169,
9152,9135,9117,9100,9083,9066,9049,9032,9014,8997,8980,8963,8946,8928,8911,8894,8877,8860,8842,8825,
8808,8791,8774,8756,8739,8722,8705,8687,8670,8653,8636,8619,8601,8584,8567,8550,8532,8515,8498,8480,
8463,8446,8429,8411,8394,8377,8360,8342,8325,8308,8290,8273,8256,8239,8221,8204,8187,8169,8152,8135,
8117,8100,8083,8065,8048,8031,8013,7996,7979,7961,7944,7927,7909,7892,7875,7857,7840,7823,7805,7788,
7771,7753,7736,7719,7701,7684,7666,7649,7632,7614,7597,7580,7562,7545,7527,7510,7493,7475,7458,7440,
7423,7406,7388,7371,7353,7336,7318,7301,7284,7266,7249,7231,7214,7196,7179,7162,7144,7127,7109,7092,
7074,7057,7039,7022,7005,6987,6970,6952,6935,6917,6900,6882,6865,6847,6830,6812,6795,6777,6760,6742,
6725,6707,6690,6672,6655,6637,6620,6602,6585,6567,6550,6532,6515,6497,6480,6462,6445,6427,6410,6392,
6375,6357,6340,6322,6305,6287,6269,6252,6234,6217,6199,6182,6164,6147,6129,6112,6094,6076,6059,6041,
6024,6006,5989,5971,5953,5936,5918,5901,5883,5866,5848,5830,5813,5795,5778,5760,5742,5725,5707,5690,
5672,5654,5637,5619,5602,5584,5566,5549,5531,5514,5496,5478,5461,5443,5425,5408,5390,5373,5355,5337,
5320,5302,5284,5267,5249,5231,5214,5196,5178,5161,5143,5126,5108,5090,5073,5055,5037,5020,5002,4984,
4967,4949,4931,4914,4896,4878,4861,4843,4825,4808,4790,4772,4755,4737,4719,4701,4684,4666,4648,4631,
4613,4595,4578,4560,4542,4525,4507,4489,4471,4454,4436,4418,4401,4383,4365,4347,4330,4312,4294,4277,
4259,4241,4223,4206,4188,4170,4153,4135,4117,4099,4082,4064,4046,4028,4011,3993,3975,3957,3940,3922,
3904,3886,3869,3851,3833,3815,3798,3780,3762,3744,3727,3709,3691,3673,3656,3638,3620,3602,3585,3567,
3549,3531,3514,3496,3478,3460,3442,3425,3407,3389,3371,3354,3336,3318,3300,3282,3265,3247,3229,3211,
3194,3176,3158,3140,3122,3105,3087,3069,3051,3033,3016,2998,2980,2962,2944,2927,2909,2891,2873,2855,
2838,2820,2802,2784,2766,2749,2731,2713,2695,2677,2660,2642,2624,2606,2588,2570,2553,2535,2517,2499,
2481,2464,2446,2428,2410,2392,2374,2357,2339,2321,2303,2285,2267,2250,2232,2214,2196,2178,2160,2143,
2125,2107,2089,2071,2053,2036,2018,2000,1982,1964,1946,1929,1911,1893,1875,1857,1839,1822,1804,1786,
1768,1750,1732,1714,1697,1679,1661,1643,1625,1607,1589,1572,1554,1536,1518,1500,1482,1465,1447,1429,
1411,1393,1375,1357,1340,1322,1304,1286,1268,1250,1232,1215,1197,1179,1161,1143,1125,1107,1090,1072,
1054,1036,1018,1000,982,964,947,929,911,893,875,857,839,822,804,786,768,750,732,714,
696,679,661,643,625,607,589,571,554,536,518,500,482,464,446,428,411,393,375,357,
339,321,303,285,268,250,232,214,196,178,160,142,125,107,89,71,53,35,17,0};

inline trigonometric sine(uint16_t original_angle){

    uint16_t positive_angle = (original_angle & 0b0111111111111111);
    //TODO - how to calculate the module in a better way in this architecture?
    uint16_t normalized_angle = positive_angle % (360 << 5);
    uint16_t last_angle = normalized_angle;

    //In this code, I changed an angle between 0 and 360 to an angle between 0 and 90
    if(normalized_angle > (180 << 5))
        last_angle = normalized_angle - (180 << 5);
    if(last_angle > (90 << 5))
        last_angle = (180 << 5) - last_angle;

    //TODO - check if CCES C can use bool variables
    //I want to avoid pipeline breaks, so I'll check in which quadrant the angle is, based on a division by 4
    uint8_t divided = normalized_angle / (90 << 5);
    uint8_t negativeSin = divided>>1;
    uint8_t negativeCos = (divided & 1) ^ negativeSin;
    negativeSin ^= original_angle >> 15;                    //cos(-theta) = cos(theta), sin(-theta) = -sin(theta)

    trigonometric to_return;
    to_return.cossine_fp    = cos_16[last_angle] | (negativeCos << 15);
    to_return.sine_fp       = cos_16[(90<<5)-last_angle] | (negativeSin << 15);       //trigonometric identity

    return to_return;
}
